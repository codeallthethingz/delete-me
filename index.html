<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Spreadsheet Table</title>
  <link href="tabulator.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" crossorigin="anonymous"></script>

  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    .search-container {
      margin-bottom: 20px;
    }

    .badge,
    .badge-skills {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: inline-block;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .badge {
      background-color: #aaaaff;
    }

    .badge:hover {
      background-color: #9999ee;
    }

    .badge-skills {
      background-color: #7984fd;
      color: #fff;
    }

    .badge-skills:hover {
      background-color: #6873ec;
    }

    .badge-size-small {
      background-color: #b6fcb6;
      color: #222;
    }

    .badge-size-small:hover {
      background-color: #a5eba5;
    }

    .badge-size-medium {
      background-color: #4ec04e;
      color: #fff;
    }

    .badge-size-medium:hover {
      background-color: #3da93d;
    }

    .badge-size-large {
      background-color: #006400;
      color: #fff;
    }

    .badge-size-large:hover {
      background-color: #004d00;
    }

    #searchInput {
      width: 100%;
      padding: 3px 6px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      font-family: sans-serif;
      transition: border-color 0.2s ease;
    }

    #searchInput:focus {
      outline: none;
      border-color: #4ec04e;
      box-shadow: 0 0 0 3px rgba(78, 192, 78, 0.1);
    }

    #searchInput::placeholder {
      color: #999;
    }

    .svg-inline--fa {
      height: 0.7rem;
      color: black;
    }
  </style>
  </head>

<body>
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Search across all fields...">
  </div>
  <div id="table"></div>

  <script type="text/javascript" src="tabulator.min.js"></script>
  <script>
    function addToSearch(value) {
      const input = document.getElementById("searchInput");
      const words = input.value.trim().split(/\s+/).filter(Boolean);
      const index = words.indexOf(value);
      if (index !== -1) words.splice(index, 1);
      else words.push(value);
      input.value = words.join(" ");
      input.dispatchEvent(new Event('input', { bubbles: true }));
    }

        function formatArrayOrStringColumn(value, cssClass) {
          const items = Array.isArray(value) ? value.filter(Boolean) :
            (value || "").split(",").map(item => item.trim()).filter(Boolean);
          return items.map(item =>
            `<span class="${cssClass}" onclick="addToSearch('${item.replace(/'/g, "\\'")}')">${item}</span>`
          ).join(" ");
    }

        function formatLinkColumn(cell, icon = "fa-external-link-alt", urlPrefix = "") {
        const value = cell.getValue();
        if (!value) return "";
        const url = urlPrefix ? `${urlPrefix}${value}` : value;
        return `<a href="${url}" target="_blank" rel="noopener noreferrer" title="${url}"><i class="fas ${icon}"></i></a>`;
    }

        const formatTagsColumn = (cell) => formatArrayOrStringColumn(cell.getValue(), "badge");
        const formatSkillsColumn = (cell) => formatArrayOrStringColumn(cell.getValue(), "badge-skills");
        const formatSizeColumn = (cell) => {
          const value = (cell.getValue() || "").trim().toLowerCase();
          return value ? `<span class="badge badge-size-${value}" onclick="addToSearch('${value}')">${value}</span>` : "";
        };
        const formatSlugLinkColumn = (cell) => formatLinkColumn(cell, "fa-external-link-alt", "https://thousandbrainsproject.readme.io/docs/");
        const formatRfcLinkColumn = (cell) => formatLinkColumn(cell);
        const formatEditLinkColumn = (cell) => formatLinkColumn(cell, "fa-pencil-alt", "https://github.com/thousandbrainsproject/tbp.monty/edit/main/");
          const formatTitleWithLinksColumn = (cell) => {
            const rowData = cell.getRow().getData();
            const title = cell.getValue() || "";
            const slug = rowData.slug || "";
            const path = rowData.path || "";

            let result = title;

            // Make title a link to docs if slug exists
            if (slug) {
              const docsUrl = `https://thousandbrainsproject.readme.io/docs/${slug}`;
              result = `<a href="${docsUrl}" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">${title}</a>`;
            }

            // Add edit icon on the right if path exists
            if (path) {
              const editUrl = `https://github.com/thousandbrainsproject/tbp.monty/edit/main/${path}`;
              result += ` <a href="${editUrl}" target="_blank" rel="noopener noreferrer" style="float: right; margin-left: 10px;" title="Edit on GitHub"><i class="fas fa-pencil-alt"></i></a>`;
            }

            return result;
          };
        const formatImplementationColumn = (cell) => {
        const value = cell.getValue();
        return value ? (value.includes(',') ?
          value.split(",").map(u => u.trim()).filter(Boolean).map(username =>
            `<img src="https://github.com/${encodeURIComponent(username)}.png" width="24" height="24" style="vertical-align:middle;border-radius:2px;" alt="${username}"/>`
          ).join(" ") : value) : "";
      };

        fetch('data.json')
        .then(res => res.json())
        .then(data => {
        const table = new Tabulator("#table", {
          data: data.filter(item => item.path1 === 'future-work' && item.path2),
          layout: 'fitDataStretch',
          initialSort: [{ column: "title", dir: "asc" }],
          columns: [
            { title: "Title", field: "title", formatter: formatTitleWithLinksColumn },
            { title: "Size", field: "size", formatter: formatSizeColumn },
            { title: "RFC", field: "rfc" },
            { title: "RFC Link", field: "rfc-link", formatter: formatRfcLinkColumn },
            { title: "Status", field: "status" },
            { title: "Implementation", field: "implementation", formatter: formatImplementationColumn },
            { title: "Tags", field: "tags", formatter: formatTagsColumn, widthGrow: 2 },
            { title: "Skills", field: "skills", formatter: formatSkillsColumn, widthGrow: 2 }
          ],
          groupBy: "path2"
        });

          document.getElementById("searchInput").addEventListener("input", e => {
            const searchTerm = e.target.value.toLowerCase().trim();
            if (!searchTerm) {
            table.clearFilter();
          } else {
            table.setFilter(data => {
              const allText = [data.title, data.tags, data.skills, data.status, data.implementation, data.size, data.link, data.path2]
                .filter(Boolean).join(" ").toLowerCase();
              return searchTerm.split(/\s+/).every(word => allText.includes(word));
            });
          }
        });
      })
        .catch(console.error);
  </script>
</body>

</html>