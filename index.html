<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Spreadsheet Table</title>
  <link href="tabulator.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" crossorigin="anonymous"></script>

  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    .badge {
      background-color: #aaaaff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: inline-block;
    }

    .badge-skills {
      background-color: #7984fd;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: inline-block;
    }

    .badge-size-small {
      background-color: #b6fcb6;
      color: #222;
    }

    .badge-size-medium {
      background-color: #4ec04e;
      color: #fff;
    }

    .badge-size-large {
      background-color: #006400;
      color: #fff;
    }

    .badge-size-unknown {
      background-color: #cccccc;
      color: #222;
    }

    #searchInput {
      width: 100%;
      padding: 3px 6px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      font-family: sans-serif;
      transition: border-color 0.2s ease;
    }

    #searchInput:focus {
      outline: none;
      border-color: #4ec04e;
      box-shadow: 0 0 0 3px rgba(78, 192, 78, 0.1);
    }

    #searchInput::placeholder {
      color: #999;
    }
  </style>
</head>

<body>
  <div style="margin-bottom: 20px;">
    <input type="text" id="searchInput" placeholder="Search across all fields...">
  </div>
  <div id="table"></div>

  <script type="text/javascript" src="tabulator.min.js"></script>
  <script>
        function formatImplementationColumn(cell, formatterParams, onRendered) {
          const usernames = (cell.getValue() || "").split(",").map(u => u.trim()).filter(Boolean);
          return usernames.map(username =>
            `<img src="https://github.com/${encodeURIComponent(username)}.png" width="24" height="24" style="vertical-align:middle;border-radius:2px;" alt="${username}"/>`
          ).join(" ");
        }

        function formatArrayOrStringColumn(value, cssClass) {
          let items = [];

        if (Array.isArray(value)) {
          items = value.filter(Boolean);
        } else if (typeof value === 'string') {
          items = value.split(",").map(item => item.trim()).filter(Boolean);
        }

        return items.map(item =>
          `<span class="${cssClass}">${item}</span>`
        ).join(" ");
      }

        function formatTagsColumn(cell, formatterParams, onRendered) {
          return formatArrayOrStringColumn(cell.getValue(), "badge");
        }

        function formatSkillsColumn(cell, formatterParams, onRendered) {
          return formatArrayOrStringColumn(cell.getValue(), "badge-skills");
        }

        function formatSizeColumn(cell, formatterParams, onRendered) {
          const value = (cell.getValue() || "").trim().toLowerCase();
          const label = value || "unknown";
          const badgeClass = `badge-size-${label}`;
          return `<span class="badge ${badgeClass}">${label}</span>`;
        }

        function formatLinkColumn(cell, formatterParams, onRendered) {
          const value = cell.getValue();
          if (!value) return "";
          const fullUrl = `https://thousandbrainsproject.readme.io/docs/${value}`;
          return `<a href="${fullUrl}" target="_blank" rel="noopener noreferrer" title="${fullUrl}">
        <i class="fas fa-external-link-alt"></i>
      </a>`;
        }
        function formatRfcLinkColumn(cell, formatterParams, onRendered) {
          const value = cell.getValue();
          if (!value) return "";
          return `<a href="${value}" target="_blank" rel="noopener noreferrer" title="${value}">
         <i class="fas fa-external-link-alt"></i>
       </a>`;
        }

        function formatEditLinkColumn(cell, formatterParams, onRendered) {
          const value = cell.getValue();
          if (!value) return "";
          const editUrl = `https://github.com/thousandbrainsproject/tbp.monty/edit/main/${value}`;
          return `<a href="${editUrl}" target="_blank" rel="noopener noreferrer" title="Edit ${value}">
       <i class="fas fa-pencil-alt"></i>
     </a>`;
        }



        function formatImplementationColumn(cell, formatterParams, onRendered) {
          const value = cell.getValue();
          if (!value) return "";
          return value;
        }

        let offline = true;
        let url = 'https://raw.githubusercontent.com/codeallthethingz/delete-me/refs/heads/main/data.json';

    if (offline) {
      url = 'data.json';
    }
        fetch(url)
          .then(res => res.json())
          .then(data => {
            // Filter for future-work items only and exclude items without path2
            const filteredData = data.filter(item => item.path1 === 'future-work' && item.path2);

          const table = new Tabulator("#table", {
            data: filteredData,
            layout: 'fitDataStretch',
            initialSort: [
              { column: "path2", dir: "asc" },
              { column: "title", dir: "asc" }
            ],
            columns: [
              {
                title: "",
              field: "slug",
              formatter: formatLinkColumn,
              hozAlign: "center"
            },
            {
              title: "",
              field: "path",
              formatter: formatEditLinkColumn,
              hozAlign: "center"
            },
            {
              title: "Title",
              field: "title"
            },
            {
              title: "Size",
              field: "size",
              formatter: formatSizeColumn
            },
            {
              title: "RFC",
              field: "rfc"
            },
            {
              title: "RFC Link",
              field: "rfc-link",
              formatter: formatRfcLinkColumn
            },
            {
              title: "Status",
              field: "status"
            },
            {
              title: "Implementation",
              field: "implementation",
              formatter: formatImplementationColumn
            },
            {
              title: "Tags",
              field: "tags",
              formatter: formatTagsColumn,
              widthGrow: 2
            },
            {
              title: "Skills",
              field: "skills",
              formatter: formatSkillsColumn,
              widthGrow: 2
            }
          ],
          groupBy: "path2"
        });

          // Add global search functionality
          const searchInput = document.getElementById("searchInput");
          searchInput.addEventListener("input", function (e) {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.trim() === "") {
              table.clearFilter();
            } else {
              // Custom filter function to search across all fields
              table.setFilter(function (data) {
                const fieldsToSearch = [
                  data.title || "",
                  data.tags || "",
                  data.skills || "",
                  data.status || "",
                  data.implementation || "",
                  data.size || "",
                  data.link || "",
                  data.path2 || ""
                ];

              // Join all field values and search within them
              const allText = fieldsToSearch.join(" ").toLowerCase();
              return allText.includes(searchTerm);
            });
          }
        });
        })
        .catch(err => console.error(err));
  </script>
</body>

</html>